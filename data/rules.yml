version: "3.1"

rules:
  # ======================================================
  # EMERGENCY & CRISIS - HIGHEST PRIORITY
  # ======================================================

  - rule: Emergency response for immediate danger
    steps:
      - intent: happening_now
      - action: utter_provide_immediate_safety

  - rule: Crisis response for panic
    steps:
      - intent: panic_crisis
      - action: utter_crisis_response

  - rule: Emergency report
    steps:
      - intent: report_emergency
      - action: utter_emergency_response

  # ======================================================
  # SIMPLE CONVERSATIONAL RESPONSES
  # ======================================================

  - rule: Handle goodbye
    steps:
      - intent: goodbye
      - action: utter_goodbye

  - rule: Handle thank you
    steps:
      - intent: thank
      - action: utter_thank

  - rule: Handle out of scope
    steps:
      - intent: out_of_scope
      - action: utter_out_of_scope

  - rule: Handle chitchat
    steps:
      - intent: chitchat
      - action: utter_chitchat

  - rule: Handle fallback
    steps:
      - intent: nlu_fallback
      - action: utter_default

  - rule: User is confused
    steps:
      - intent: confused
      - action: utter_clarify

  - rule: User asks why
    steps:
      - intent: ask_why_question
      - action: utter_explain_data_use

  # ======================================================
  # STOP & CONTROL (Universal)
  # ======================================================

  - rule: User wants to stop reporting
    steps:
      - intent: stop_reporting
      - action: utter_stop_reporting
      - action: action_save_progress

  - rule: Withdraw consent
    steps:
      - intent: withdraw_consent
      - action: utter_withdraw_consent
      - action: action_save_progress

  # ======================================================
  # RESOURCE REQUESTS (Standalone - Outside Forms)
  # ======================================================

  - rule: Provide national hotlines
    condition:
    - active_loop: null
    steps:
      - intent: ask_national_hotlines
      - action: action_get_national_hotlines

  - rule: Ask about costs
    condition:
    - active_loop: null
    steps:
      - intent: ask_about_costs
      - action: utter_explain_free_services

  - rule: Ask about hours
    condition:
    - active_loop: null
    steps:
      - intent: ask_about_hours
      - action: action_get_national_hotlines

  - rule: Request resources standalone
    condition:
    - active_loop: null
    steps:
      - intent: request_resources
      - action: action_provide_resources

  - rule: Ask about resources standalone
    condition:
    - active_loop: null
    steps:
      - intent: ask_about_resources
      - action: action_provide_resources

  # ======================================================
  # SERVICE SEARCH (Standalone)
  # ======================================================

  - rule: Search medical facilities
    condition:
    - active_loop: null
    steps:
      - intent: search_medical_facilities
      - action: utter_ask_county_for_resources

  - rule: Search legal services
    condition:
    - active_loop: null
    steps:
      - intent: search_legal_services
      - action: utter_ask_county_for_resources

  - rule: Search counseling services
    condition:
    - active_loop: null
    steps:
      - intent: search_counseling_services
      - action: utter_ask_county_for_resources

  - rule: Search shelters
    condition:
    - active_loop: null
    steps:
      - intent: search_shelter_options
      - action: utter_ask_county_for_resources

  - rule: Search police stations
    condition:
    - active_loop: null
    steps:
      - intent: search_police_stations
      - action: utter_ask_county_for_resources

  - rule: Ask for county resources
    condition:
    - active_loop: null
    steps:
      - intent: ask_resources_by_county
      - action: utter_ask_county_for_resources
    # ======================================================
  # FORM HANDLING
  # ======================================================

  - rule: Activate form after consent
    condition:
    - slot_was_set:
      - consent_given: true
    steps:
      - action: incident_report_form
      - active_loop: incident_report_form

  - rule: Submit completed form
    condition:
    - active_loop: incident_report_form
    steps:
      - action: incident_report_form
      - active_loop: null
      - action: action_submit_report

  # ======================================================
  # FORM INTERRUPTIONS
  # ======================================================

  - rule: Handle crisis during form
    steps:
      - active_loop: incident_report_form
      - intent: panic_crisis
      - action: utter_crisis_response
      - action: action_assess_safety
      - action: incident_report_form
      - active_loop: incident_report_form

  - rule: Handle break during form
    steps:
      - active_loop: incident_report_form
      - intent: take_break
      - action: action_save_progress
      - action: utter_save_progress
      - active_loop: null

  - rule: Handle overwhelm during form
    steps:
      - active_loop: incident_report_form
      - intent: express_overwhelm
      - action: action_check_distress_level
      - action: utter_offer_break
      - action: incident_report_form
      - active_loop: incident_report_form
